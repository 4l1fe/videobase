// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  var App, CommentThumb, CommentsDeck, Deck, FilmThumb, FilmsDeck, Item, Page, Page_Film, Page_Login, Page_Main, Page_Person, Page_Playlist, Page_Registration, PersonThumb, PersonsDeck, Player, check_app_is_init, error, location_type_to_text, locations_type_text, state_toggle,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.mi_app = void 0;

  error = function(txt, type) {
    if (type == null) {
      type = "norm";
    }
    if (type === "crit") {
      throw new Error("CRITICAL ERROR: " + txt);
    } else {
      return console.log("ERROR: " + txt);
    }
  };

  check_app_is_init = function(c) {
    if (!window.mi_app) {
      return error("App is not init", "crit");
    } else {
      return c._app = window.mi_app;
    }
  };

  state_toggle = function(new_state, cur_state, deflt) {
    if (new_state === void 0) {
      if (cur_state === void 0) {
        if (deflt !== void 0) {
          return deflt;
        } else {
          return 1;
        }
      } else if (cur_state) {
        return 0;
      } else {
        return 1;
      }
    } else {
      return typeof new_state === "function" ? new_state({
        1: 0
      }) : void 0;
    }
  };

  locations_type_text = {
    ivi: "IVI.ru",
    nowru: "NOW.ru",
    zoomby: "Zoomby.ru",
    megogo: "Megogo.net",
    tvigle: "Tvigle.ru",
    playfamily: "PlayFamily.ru",
    amediateka: "Amediateka",
    molodejj: "Molodejj.tv",
    stream: "Stream.ru",
    tvzavr: "TVzavr.ru",
    viaplay: "Viaplay.ru",
    zabava: "Zabava.ru",
    playgoogle: "Play Google",
    itunes: "Apple Itunes",
    ayyo: "Ayyo.ru",
    mosfilm: "Cinema.mosfilm.ru",
    olltv: "oll.tv"
  };

  location_type_to_text = function(type) {
    return locations_type_text[type.toLowerCase()] || type;
  };

  Player = (function() {
    function Player(place, opts) {
      this.place = place;
      if (opts == null) {
        opts = {};
      }
      this.current = void 0;
    }

    Player.prototype.load = function(loc) {
      var arr, height, html, ratio, type, value, width;
      if (this.current !== void 0) {
        this.clear();
      }
      html = void 0;
      type = loc.type;
      value = loc.value;
      ratio = 1;
      width = this.place.width();
      if (type === "ivi") {
        value = loc.url_view.substr(24);
        value = value.substr(0, value.indexOf("#"));
        ratio = 640 / 360;
        height = parseInt(width / ratio);
        html = '<object id="DigitalaccessVideoPlayer" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="100%" height="100%" type="application/x-shockwave-flash" data="http://www.ivi.ru/video/player?siteId=s138&amp;_isB2C=1&amp;autoStart=1&amp;videoId=' + value + '&amp;allowSeriesPlaylist=1&amp;disableiviredirect=0&amp;share_embed=0"><param name="movie" value="http://www.ivi.ru/video/player?siteId=s138&amp;_isB2C=1&amp;autoStart=1&amp;videoId=' + value + '&amp;allowSeriesPlaylist=1&amp;disableiviredirect=0&amp;share_embed=0"><param name="allowScriptAccess" value="always"><param name="allowFullScreen" value="true"><param name="bgcolor" value="#000000"><param name="wmode" value="opaque"><embed quality="high" allowscriptaccess="always" allowfullscreen="true" wmode="opaque" width="100%" height="100%" type="application/x-shockwave-flash" src="http://www.ivi.ru/video/player?siteId=s138&amp;_isB2C=1&amp;autoStart=1&amp;videoId=' + value + '&amp;allowSeriesPlaylist=1&amp;disableiviredirect=0&amp;share_embed=0"></object>';
      } else if (type === "nowru") {
        arr = loc.url_view.split("/");
        value = arr[arr.length - 1];
        html = '<iframe name="now1023318" src="http://www.now.ru/embed/frame/' + value + '" scrolling="no" frameborder="no" height="100%" width="100%"></iframe>';
        ratio = 860 / 480;
      } else if (type === "tvigle") {
        arr = loc.url_view.split("=");
        value = arr[arr.length - 1];
        ratio = 720 / 539;
        height = Math.round(width / ratio);
        html = '<object type="application/x-shockwave-flash" data="http://tvigle.ru/swf/tvigle_v12.swf?ver=3.597999999999975" width="1080" height="608" id="plr" style="visibility: visible; width: 1080px; height: 607.5px;"><param name="allowScriptAccess" value="always"><param name="bgcolor" value="#000000"><param name="quality" value="high"><param name="scale" value="noscale"><param name="allowFullScreen" value="true"><param name="wmode" value="opaque"><param name="flashvars" value="ref=1&amp;obj=' + value + '&amp;cnl=692685&amp;sid_name=&amp;user_sid=&amp;own=0&amp;w=1080&amp;h=608&amp;ap=1&amp;afbr=1&amp;region=RU&amp;skin=&amp;d=tvigle.ru"></object>';
      } else if (type === "streamru") {
        html = "";
      } else if (type === "zoomby") {
        value = 184209;
        html = '<iframe src="http://www.zoomby.ru/v/' + value + '" width="100%" height="100%"></iframe>';
        ratio = 640 / 360;
      }
      if (html !== void 0) {
        this.current = loc;
        return this.place.height(this.place.width() / ratio).html(html);
      }
    };

    Player.prototype.clear = function() {
      this.place.addClass("player-empty");
      this.place.empty().height("auto");
      return this.current = void 0;
    };

    return Player;

  })();

  Page = (function() {
    function Page() {
      check_app_is_init(this);
      this._e = {};
      this._visible = false;
    }

    Page.prototype.show = function() {
      return this._visible = true;
    };

    Page.prototype.hide = function() {
      return this._visible = false;
    };

    Page.prototype.isVisible = function() {
      return this._visible;
    };

    Page.prototype.user_is_auth = function() {
      return this._app.user_is_auth();
    };

    return Page;

  })();

  Item = (function() {
    function Item(opts, callback) {
      if (opts == null) {
        opts = {};
      }
      if (callback == null) {
        callback = void 0;
      }
      check_app_is_init(this);
      if (!this._name) {
        error("It's wrong to use parent class", "crit");
      }
      this.vals = {};
      this.defaults = {};
      this.elements = {};
      this.e_attrs = {};
      this.e_vals = {};
      if (opts.defaults) {
        $.extend(this.defaults, opts.defaults);
      }
      if (opts.place === void 0) {
        this._place = $('<span class="preload-' + this._name + '"></span>');
        if (opts.parent) {
          this._place.appendTo(opts.parent);
        }
        this._app.get_tpl(this._name, (function(_this) {
          return function(tpl_obj) {
            var old_place;
            if (tpl_obj) {
              old_place = _this._place;
              _this._place = tpl_obj.clone();
              _this.set_elements();
              if (opts.vals) {
                _this.set_vals(opts.vals, opts.do_not_set);
              }
              _this._place.insertAfter(old_place);
              old_place.remove();
              if (callback) {
                return callback(_this);
              }
            } else {
              return error('Unable to load template for object "' + _this._name + '"');
            }
          };
        })(this));
      } else {
        this._place = opts.place;
        this.set_elements();
        if (opts.vals) {
          this.set_vals(opts.vals, opts.do_not_set);
        }
        if (callback) {
          callback(this);
        }
      }
    }

    Item.prototype.place = function() {
      return this._place;
    };

    Item.prototype.parse_element = function($this) {
      var data, e, name, value;
      data = $this.data();
      name = void 0;
      value = void 0;
      e = {
        self: $this
      };
      return $.each(data, (function(_this) {
        return function(key, val) {
          var attr, i, method, name_arr, o;
          key = key.substr(2).toLowerCase();
          if (key === "id") {
            _this.elements[val] = e;
            if (name === void 0) {
              name = key;
            }
          }
          if (key === "name") {
            name = val;
            if (_this.e_vals[val] === void 0) {
              _this.e_vals[val] = [];
            }
            _this.e_vals[val].push(e);
          } else if (key.substr(0, 2) === "on") {
            method = key.substr(2);
            if (typeof _this[val] === "function") {
              $this.bind(method, function() {
                return _this[val]();
              });
            }
          } else if (key.substr(0, 2) === "at") {
            attr = key.substr(2);
            if (e.attr === void 0) {
              e.attr = {};
            }
            e.attr[attr] = val;
            if (_this.e_attrs[val] === void 0) {
              _this.e_attrs[val] = {};
            }
            if (_this.e_attrs[val][attr] === void 0) {
              _this.e_attrs[val][attr] = [];
            }
            _this.e_attrs[val][attr].push(e);
          } else {
            e[key] = val;
            if (key === "val") {
              value = val;
            }
          }
          if (name !== void 0 && value !== void 0) {
            name_arr = name.split(".");
            o = _this.vals;
            i = 0;
            while (i < name_arr.length - 2) {
              o = o[name_arr[i]];
              if (o === void 0) {
                o = {};
              }
              i++;
            }
            return o[name_arr[i]] = value;
          }
        };
      })(this));
    };

    Item.prototype.set_elements = function() {
      var self;
      this.elements = {};
      self = this;
      $("*", this._place).each(function() {
        return self.parse_element($(this));
      });
      return this.parse_element(this._place);
    };

    Item.prototype.get_val = function(name) {
      if (name) {
        return this.vals[name];
      } else {
        return this.vals;
      }
    };

    Item.prototype.set_val = function(name, val, do_not_set) {
      val = this.transform_val(name, val);
      this.vals[name] = val;
      if (!do_not_set) {
        return this.iterate_val(name, val || this.defaults[name]);
      }
    };

    Item.prototype.iterate_val = function(s, obj) {
      var attr, e, key, val, _i, _len, _ref, _results, _results1;
      if (typeof obj === "object") {
        _results = [];
        for (key in obj) {
          _results.push(this.iterate_val(s + "." + key, obj[key]));
        }
        return _results;
      } else {
        if (this.e_vals[s]) {
          _ref = this.e_vals[s];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            e = _ref[_i];
            e.self.html(obj || e["default"]);
          }
        }
        if (this.e_attrs[s]) {
          _results1 = [];
          for (attr in this.e_attrs[s]) {
            _results1.push((function() {
              var _j, _len1, _ref1, _results2;
              _ref1 = this.e_attrs[s][attr];
              _results2 = [];
              for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                e = _ref1[_j];
                val = this.transform_attr(attr, s, obj);
                if (attr === "bg") {
                  _results2.push(e.self.background_image(val || e["default"]));
                } else {
                  _results2.push(e.self.attr(attr, val || e["default"]));
                }
              }
              return _results2;
            }).call(this));
          }
          return _results1;
        }
      }
    };

    Item.prototype.set_vals = function(vals, do_not_set) {
      var key, val;
      this.reset();
      for (key in vals) {
        val = vals[key];
        this.set_val(key, val, do_not_set);
      }
      return vals;
    };

    Item.prototype.transform_val = function(name, val) {
      return val;
    };

    Item.prototype.transform_attr = function(attr, name, val) {
      return val;
    };

    Item.prototype.user_is_auth = function() {
      return this._app.user_is_auth();
    };

    Item.prototype.reset = function() {
      return this.vals = {};
    };

    Item.prototype.show = function() {
      return this._place.show();
    };

    Item.prototype.hide = function() {
      return this._place.hide();
    };

    Item.prototype.remove = function() {
      return this._place.remove();
    };

    return Item;

  })();

  FilmThumb = (function(_super) {
    __extends(FilmThumb, _super);

    function FilmThumb(opts, callback) {
      if (opts == null) {
        opts = {};
      }
      this._name = "film-thumb";
      FilmThumb.__super__.constructor.call(this, opts, (function(_this) {
        return function() {
          var ri;
          ri = _this.elements["relation.rating"].self;
          if (!opts.place) {
            ri.rateit();
          }
          return ri.rateit("min", 0).rateit("max", 10).bind("beforerated beforereset", function(event) {
            if (!_this.user_is_auth()) {
              return event.preventDefault();
            }
          }).bind("reset rated", function(event) {
            return _this.action_rate(ri.rateit("value"));
          });
        };
      })(this));
    }

    FilmThumb.prototype.transform_attr = function(attr, name, val) {
      if (attr === "href" && name === "id") {
        return "/films/" + val;
      } else {
        return val;
      }
    };

    FilmThumb.prototype.transform_val = function(name, val) {
      if (name === "releasedate") {
        return " (" + val.substr(0, 4) + ")";
      } else {
        return FilmThumb.__super__.transform_val.apply(this, arguments);
      }
    };

    FilmThumb.prototype.set_vals = function(vals, do_not_set) {
      var loc, _i, _len, _ref;
      if (vals.locations && vals.locations.length) {
        this.elements["notinstock"].self.hide();
        this.elements["instock"].self.show();
        vals.hasFree = false;
        vals.price = 0;
        _ref = vals.locations;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          loc = _ref[_i];
          loc.price = parseFloat(loc.price || 0);
          if (loc.price_type === 0) {
            vals.hasFree = true;
          } else if (loc.price && (vals.price === 0 || loc.price < vals.price)) {
            vals.price = loc.price;
          }
        }
        if (vals.hasFree) {
          this.elements["watch_btn"].self.html("Смотреть<br/>Бесплатно").parent().removeClass("button-priced");
          if (vals.price) {
            this.elements["watch_price"].self.visible();
          } else {
            this.elements["watch_price"].self.invisible();
          }
        } else {
          this.elements["watch_price"].self.invisible();
          this.elements["watch_btn"].self.html('Смотреть<br/><span>от <span class="price">' + loc.price + '</span> р. без рекламы</span>').parent().addClass("button-priced");
        }
      } else {
        this.elements["notinstock"].self.show();
        this.elements["instock"].self.hide();
      }
      return FilmThumb.__super__.set_vals.apply(this, arguments);
    };

    FilmThumb.prototype.action_rate = function(val) {
      return this._app.film_action(this.vals.id, "rate", {
        rel: this.vals.relation,
        value: val,
        callback: (function(_this) {
          return function(new_state) {
            return alert("done");
          };
        })(this)
      });
    };

    FilmThumb.prototype.toggle_playlist = function(status) {
      return this._app.film_action(this.vals.id, "playlist", {
        rel: this.vals.relation,
        state: status,
        callback: (function(_this) {
          return function(new_state) {
            return alert("done");
          };
        })(this)
      });
    };

    FilmThumb.prototype.toggle_notwatch = function(status) {
      return this._app.film_action(this.vals.id, "notwatch", {
        rel: this.vals.relation,
        state: status,
        callback: (function(_this) {
          return function(new_state) {
            return alert("done");
          };
        })(this)
      });
    };

    FilmThumb.prototype.toggle_subscribe = function(status) {
      return this._app.film_action(this.vals.id, "subscribe", {
        rel: this.vals.relation,
        state: status,
        callback: (function(_this) {
          return function(new_state) {
            return alert("done");
          };
        })(this)
      });
    };

    FilmThumb.prototype.watchfilm = function() {
      return location.href = "/films/" + this.vals.id;
    };

    return FilmThumb;

  })(Item);

  CommentThumb = (function(_super) {
    __extends(CommentThumb, _super);

    function CommentThumb() {
      this._name = "comment-thumb";
      CommentThumb.__super__.constructor.apply(this, arguments);
    }

    CommentThumb.prototype.transform_attr = function(attr, name, val) {
      if (attr === "href" && name === "user.id") {
        return "/users/" + val;
      } else {
        return CommentThumb.__super__.transform_attr.apply(this, arguments);
      }
    };

    CommentThumb.prototype.transform_val = function(name, val) {
      return CommentThumb.__super__.transform_val.apply(this, arguments);
    };

    CommentThumb.prototype.set_vals = function(vals, do_not_set) {
      if (vals.created) {
        if (!vals.time_text) {
          vals.time_text = time_text(new Date(vals.created));
        }
        this.elements["time_text"].val = vals.created;
      }
      return CommentThumb.__super__.set_vals.apply(this, arguments);
    };

    return CommentThumb;

  })(Item);

  PersonThumb = (function(_super) {
    __extends(PersonThumb, _super);

    function PersonThumb(opts, callback) {
      if (opts == null) {
        opts = {};
      }
      this._name = "person-thumb";
      PersonThumb.__super__.constructor.apply(this, arguments);
    }

    PersonThumb.prototype.transform_attr = function(attr, name, val) {
      if (attr === "href" && name === "id") {
        return "/persons/" + val;
      } else {
        return PersonThumb.__super__.transform_attr.apply(this, arguments);
      }
    };

    return PersonThumb;

  })(Item);

  Deck = (function() {
    function Deck(_place, opts) {
      var self;
      this._place = _place;
      if (opts == null) {
        opts = {};
      }
      this.load_counter = 0;
      this.page = 0;
      this.load_func = void 0;
      this.items = [];
      this.more = {};
      self = this;
      $("." + this.element_name, this._place).each(function() {
        return self.add_item_DOM($(this));
      });
      if (opts.load_func) {
        this.load_func = opts.load_func;
      }
      if (opts.more_place) {
        this.load_more_bind(opts.more_place);
      }
    }

    Deck.prototype.add_item_DOM = function(obj) {
      return this.items.push(new this.item_class({
        place: obj,
        do_not_set: true
      }));
    };

    Deck.prototype.add_item = function(item) {
      return this.items.push(new this.item_class({
        parent: this._place,
        vals: item
      }));
    };

    Deck.prototype.add_items = function(items) {
      var item, _i, _len, _results;
      _results = [];
      for (_i = 0, _len = items.length; _i < _len; _i++) {
        item = items[_i];
        _results.push(this.add_item(item));
      }
      return _results;
    };

    Deck.prototype.get_items = function() {
      return this.items;
    };

    Deck.prototype.load_more_bind = function(place) {
      this.more.place = place;
      this.more.btn = $("button", place);
      return this.more.btn.click((function(_this) {
        return function() {
          return _this.load_more();
        };
      })(this));
    };

    Deck.prototype.load_more = function(opts) {
      if (this.load_func !== void 0) {
        this.load_counter++;
        return this.load_func(this, opts);
      }
    };

    Deck.prototype.load_more_hide = function() {
      if (this.more.place) {
        return this.more.place.hide();
      }
    };

    Deck.prototype.load_more_show = function() {
      if (this.more.place) {
        return this.more.place.show();
      }
    };

    Deck.prototype.clear = function() {
      var item, _i, _len, _ref;
      this.load_counter++;
      _ref = this.items;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item.remove();
      }
      this.items = [];
      this._place.empty();
      return this.page = 0;
    };

    return Deck;

  })();

  CommentsDeck = (function(_super) {
    __extends(CommentsDeck, _super);

    function CommentsDeck(place, opts) {
      if (opts == null) {
        opts = {};
      }
      this.element_name = "comment-thumb";
      this.item_class = CommentThumb;
      CommentsDeck.__super__.constructor.apply(this, arguments);
      setInterval((function(_this) {
        return function() {
          return _this.time_update();
        };
      })(this), 5000);
      this.time_update();
    }

    CommentsDeck.prototype.time_update = function() {
      var item, _i, _len, _ref, _results;
      _ref = this.items;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.elements.time_text.val) {
          _results.push(item.elements.time_text.self.text(time_text(new Date(item.elements.time_text.val))));
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    return CommentsDeck;

  })(Deck);

  FilmsDeck = (function(_super) {
    __extends(FilmsDeck, _super);

    function FilmsDeck(place, opts) {
      if (opts == null) {
        opts = {};
      }
      this.element_name = "film-thumb";
      this.item_class = FilmThumb;
      FilmsDeck.__super__.constructor.apply(this, arguments);
    }

    return FilmsDeck;

  })(Deck);

  PersonsDeck = (function(_super) {
    __extends(PersonsDeck, _super);

    function PersonsDeck(place, opts) {
      this.element_name = "person-thumb";
      this.item_class = PersonThumb;
      PersonsDeck.__super__.constructor.apply(this, arguments);
    }

    return PersonsDeck;

  })(Deck);

  App = (function() {
    var active_page, conf, pages, query_params, templates, user;

    conf = window.mi_conf || {};

    user = {
      id: null,
      name: ""
    };

    templates = {};

    pages = {};

    active_page = void 0;

    query_params = void 0;

    function App(opts, name) {
      if (opts == null) {
        opts = {};
      }
      if (window.mi_app) {
        error("App is already running", "crit");
      }
      window.mi_app = this;
      if (!$.RestClient) {
        error("No Rest Library found");
      }
      $.extend(conf, opts);
      this.rest = new $.RestClient(conf.api_url);
      this.rest.add("user");
      this.rest.add("users");
      this.rest.users.add("films");
      this.rest.users.add("persons");
      this.rest.users.add("friendship");
      this.rest.users.add("friends");
      this.rest.users.add("feed");
      this.rest.add("films");
      this.rest.films.add("search");
      this.rest.films.add("persons");
      this.rest.films.add("action", {
        isSingle: true
      });
      this.rest.films.action.add("rate");
      this.rest.films.action.add("subscribe");
      this.rest.films.action.add("notwatch");
      this.rest.films.action.add("playlist");
      this.rest.add("persons");
      this.rest.persons.add("filmography", {
        isSingle: true
      });
      this.rest.persons.add("action", {
        isSingle: true
      });
      this.rest.persons.action.add("subscribe");
      if (name !== void 0) {
        this.show_page(name, conf.page_conf);
      }
    }

    App.prototype.film_action = function(id, action, opts) {
      var action_str, doit, new_state, rel;
      if (opts == null) {
        opts = {};
      }
      if (this.user_is_auth()) {
        rel = opts.rel || {};
        action_str = action;
        if (action === "subscribe") {
          action_str += "d";
        }
        new_state = state_toggle(opts.status, rel[action_str]);
        if (action === "rate") {
          if (!opts.value) {
            return this.rest.films.action.rate.destroy(id).done(function() {
              if (opts.rel) {
                rel.rating = false;
              }
              if (opts.callback) {
                return opts.callback(false);
              }
            });
          } else {
            return this.rest.films.action.rate.update(id, {
              rating: opts.value
            }).done(function() {
              if (opts.rel) {
                rel.rating = false;
              }
              if (opts.callback) {
                return opts.callback(opts.value);
              }
            });
          }
        } else {
          if (new_state) {
            doit = "update";
          } else {
            doit = "destroy";
          }
          return this.rest.films.action[action][doit](id).done(function() {
            if (opts.rel) {
              rel[action_str] = new_state;
            }
            if (opts.callback) {
              return opts.callback(new_state);
            }
          });
        }
      }
    };

    App.prototype.person_action = function(id, action, opts) {
      var action_str, doit, new_state, rel;
      if (opts == null) {
        opts = {};
      }
      if (this.user_is_auth()) {
        rel = opts.rel || {};
        action_str = action;
        if (action === "subscribe") {
          action_str += "d";
        }
        new_state = state_toggle(opts.status, rel[action_str]);
        if (new_state) {
          doit = "update";
        } else {
          doit = "destroy";
        }
        return this.rest.persons.action[action][doit](id).done(function() {
          if (opts.rel) {
            rel[action_str] = new_state;
          }
          if (opts.callback) {
            return opts.callback(new_state);
          }
        });
      }
    };

    App.prototype.config = function(name) {
      if (name === void 0) {
        return conf;
      } else {
        return conf[name];
      }
    };

    App.prototype.user_is_auth = function(ask_sign_in) {
      if (ask_sign_in == null) {
        ask_sign_in = true;
      }
      if (!this.rest.has_auth()) {
        if (ask_sign_in) {
          alert("sign in first");
        }
        return false;
      } else {
        return true;
      }
    };

    App.prototype.query_params = function(name) {
      if (!query_params) {
        query_params = $.parseParams();
      }
      if (name) {
        return query_params[name];
      } else {
        return query_params;
      }
    };

    App.prototype.get_tpl = function(name, callback) {
      var ajax_opts;
      if (templates[name]) {
        if (callback) {
          return callback(templates[name]);
        }
      } else {
        ajax_opts = {
          url: this.config("tpl_url") + name + ".html",
          dataType: "html",
          error: function() {
            error("Unable to load template name \"" + name + "\"");
            if (callback) {
              return callback(void 0);
            }
          },
          success: (function(_this) {
            return function(data) {
              if (callback) {
                return callback(templates[name] = $(data));
              }
            };
          })(this)
        };
        return $.ajax(ajax_opts);
      }
    };

    App.prototype.register_tpl = function(name, jObj) {
      return templates[name] = jObj;
    };

    App.prototype.hide_page = function(name) {
      if (!_pages[name]) {
        if (active_page === name) {
          pages[name].hide();
          return active_page = void 0;
        } else {
          return error("Page " + name + " is not active");
        }
      } else {
        return error("No page " + name + "found");
      }
    };

    App.prototype.show_page = function(name, conf) {
      var p;
      p = this.page(name, conf);
      if (p) {
        active_page = name;
        return p.show();
      } else {
        return error("No page " + name + "found");
      }
    };

    App.prototype.active_page = function() {
      return active_page;
    };

    App.prototype.page = function(name, conf) {
      var page_obj;
      if (name === void 0) {
        name = active_page;
      }
      if (pages[name]) {
        return pages[name];
      }
      page_obj = new (eval("Page_" + name))(conf);
      return pages[name] = page_obj;
    };

    return App;

  })();

  Page_Main = (function(_super) {
    var films_deck, self, _filter_counter, _filter_params;

    __extends(Page_Main, _super);

    films_deck = void 0;

    self = void 0;

    _filter_params = {};

    _filter_counter = 0;

    function Page_Main() {
      var el, filter_name, filter_obj, key, param_name, param_value, params, _ref, _ref1;
      self = this;
      Page_Main.__super__.constructor.apply(this, arguments);
      this._app.get_tpl("film-thumb");
      films_deck = new FilmsDeck($("#films"), {
        load_func: this.load_more_films
      });
      films_deck.load_more_bind($("#films_more"));
      $(".film-thumb", $("#films_new")).each(function() {
        return new FilmThumb({
          place: $(this),
          do_not_set: true
        });
      });
      this._e.filter = {
        parent: $("#frm_filter"),
        genre: $("#sel_genre"),
        year_old: $("#sel_year_old"),
        rating: $("#sel_rating"),
        price: $("#sel_price")
      };
      _ref = this._e.filter;
      for (key in _ref) {
        el = _ref[key];
        el.change(((function(_this) {
          return function() {
            return _this.filter_changed_event();
          };
        })(this)));
      }
      params = this._app.query_params();
      if (params) {
        if (params.q) {
          _filter_params.text = params.q;
        }
        for (param_name in params) {
          param_value = params[param_name];
          _ref1 = this._e.filter;
          for (filter_name in _ref1) {
            filter_obj = _ref1[filter_name];
            if (filter_name === param_name) {
              $("option", filter_obj).each(function() {
                var e;
                e = $(this);
                return e.prop("selected", e.val() === param_value);
              });
            }
          }
        }
      }
      this.update_filter_params();
      films_deck.load_more();
    }

    Page_Main.prototype.filter_changed_event = function() {
      return this.filter_changed();
    };

    Page_Main.prototype.filter_changed = function(text) {
      var current_filter_counter;
      _filter_counter++;
      if (text !== void 0) {
        _filter_params.text = text;
      }
      current_filter_counter = _filter_counter;
      return setTimeout((function(_this) {
        return function() {
          var opts;
          if (_filter_counter === current_filter_counter) {
            _this.update_filter_params();
            opts = {
              clear_output: true,
              page_loading: false,
              params: _filter_params
            };
            return _this.load_more_films(films_deck, opts);
          }
        };
      })(this), this._app.config("filter_delay"));
    };

    Page_Main.prototype.update_filter_params = function(update_href) {
      var el, key, query_string, val, _ref;
      if (update_href == null) {
        update_href = true;
      }
      if (_filter_params.text) {
        query_string = "text=" + encodeURI(_filter_params.text);
      } else {
        query_string = "";
      }
      if (films_deck.page) {
        _filter_params.page = films_deck.page;
        if (query_string) {
          query_string += "&";
        }
        query_string += "page=" + films_deck.page;
      }
      _ref = this._e.filter;
      for (key in _ref) {
        el = _ref[key];
        val = el.val();
        if (val && val !== "0") {
          _filter_params[key] = val;
          if (query_string) {
            query_string += "&";
          }
          query_string += key + "=" + val;
        } else {
          _filter_params[key] = null;
        }
      }
      if (query_string) {
        query_string = "?" + query_string;
      }
      if (update_href) {
        if (history && history.pushState) {
          return history.pushState(null, null, query_string);
        }
      }
    };

    Page_Main.prototype.load_more_films = function(deck, opts) {
      var current_counter;
      if (opts == null) {
        opts = {};
      }
      if (opts.clear_output) {
        deck.clear();
      }
      current_counter = deck.load_counter;
      deck.load_more_hide();
      if (!opts.params) {
        opts.params = {};
      }
      return self._app.rest.films.read("search", opts.params).done((function(_this) {
        return function(data) {
          if (current_counter !== deck.load_counter) {
            return;
          }
          if (data.items) {
            deck.add_items(data.items);
          }
          if (Math.ceil(data.total_cnt / data.per_page) > data.page) {
            deck.load_more_show();
            deck.page = data.page;
          }
          if (opts.callback) {
            return opts.callback();
          }
        };
      })(this)).fail((function(_this) {
        return function(data) {};
      })(this));
    };

    return Page_Main;

  })(Page);

  Page_Login = (function(_super) {
    __extends(Page_Login, _super);

    function Page_Login() {
      return Page_Login.__super__.constructor.apply(this, arguments);
    }

    return Page_Login;

  })(Page);

  Page_Registration = (function(_super) {
    __extends(Page_Registration, _super);

    function Page_Registration() {
      return Page_Registration.__super__.constructor.apply(this, arguments);
    }

    Page_Registration.constructor = function() {
      Page_Registration.__super__.constructor.constructor.apply(this, arguments);
      return $("#frm_reg").submit(function() {
        return false;
      });
    };

    return Page_Registration;

  })(Page);

  Page_Film = (function(_super) {
    var actors_deck, comments_deck, film_id, films_deck, locations, params;

    __extends(Page_Film, _super);

    film_id = void 0;

    films_deck = void 0;

    comments_deck = void 0;

    actors_deck = void 0;

    locations = {};

    params = void 0;

    function Page_Film(conf) {
      var item, key, loc_id, self;
      this.conf = conf;
      Page_Film.__super__.constructor.apply(this, arguments);
      films_deck = new FilmsDeck($("#films"));
      comments_deck = new CommentsDeck($("#comments"));
      actors_deck = new PersonsDeck($("#actors"), {
        load_func: (function(_this) {
          return function() {
            return _this.load_all_actors();
          };
        })(this)
      });
      actors_deck.load_more_bind($("#actors_more"));
      this._e.rateit = $("#rateit");
      this._e.rateit.rateit("min", 0).rateit("max", 10).bind("beforerated beforereset", (function(_this) {
        return function(event) {
          if (!_this.user_is_auth()) {
            return event.preventDefault();
          }
        };
      })(this)).bind("reset rated", (function(_this) {
        return function(event) {
          return _this.action_rate(_this._e.rateit.rateit("value"));
        };
      })(this));
      this._e.notwatch_btn = $("#notwatch_btn");
      if (this._e.notwatch_btn.length) {
        this._e.notwatch_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_notwatch_toggle();
          };
        })(this));
      }
      this._e.playlist_btn = $("#playlist_btn");
      if (this._e.playlist_btn.length) {
        this._e.playlist_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_playlist_toggle();
          };
        })(this));
      }
      this._e.subscribe_btn = $("#subscribe_btn");
      if (this._e.subscribe_btn.length) {
        this._e.subscribe_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_subscribe_toggle();
          };
        })(this));
      }
      self = this;
      if (this.conf.locations && this.conf.locations.length) {
        $(".location-thumb", $("#locations")).each(function() {
          var $this, i, id, loc;
          $this = $(this);
          id = $this.data("miVal");
          i = 0;
          loc = void 0;
          while (i < self.conf.locations.length && self.conf.locations[i].id !== id) {
            i++;
          }
          if (i < self.conf.locations.length) {
            loc = self.conf.locations[i];
          }
          if (loc) {
            $this.click(function() {
              return self.play_location(id);
            });
            $(".type", $this).text(location_type_to_text(loc.type));
            if (loc.price_type === 0 || loc.price === 0) {
              $(".price", $this).text("смотреть бесплатно");
            } else {
              $(".price", $this).text(loc.price + " р.");
            }
            loc._el = $this;
            return locations[id] = loc;
          }
        });
        this.player = new Player($("#player"));
        this.player.clear();
        loc_id = this._app.query_params("loc");
        if (!loc_id) {
          for (key in locations) {
            item = locations[key];
            if (item.price_type === 0) {
              loc_id = key;
            }
          }
        }
        if (loc_id) {
          this.play_location(loc_id);
        }
      }
    }

    Page_Film.prototype.play_location = function(id) {
      if (locations[id]) {
        return this.player.load(locations[id]);
      }
    };

    Page_Film.prototype.load_all_actors = function() {
      actors_deck.load_more_hide();
      return this._app.rest.films.persons.read(this.conf.id, {
        type: "a",
        top: actors_deck.get_items().length
      }).done((function(_this) {
        return function(data) {
          if (data && data.length) {
            return actors_deck.add_items(data);
          }
        };
      })(this));
    };

    Page_Film.prototype.action_rate = function(val) {
      return this._app.film_action(this.conf.id, "rate", {
        rel: this.conf.relation,
        value: val,
        callback: (function(_this) {
          return function(new_value) {
            return alert("done");
          };
        })(this)
      });
    };

    Page_Film.prototype.action_notwatch_toggle = function(status) {
      return this._app.film_action(this.conf.id, "notwatch", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    Page_Film.prototype.action_subscribe_toggle = function(status) {
      return this._app.film_action(this.conf.id, "subscribe", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    Page_Film.prototype.action_playlist_toggle = function(status) {
      return this._app.film_action(this.conf.id, "playlist", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    return Page_Film;

  })(Page);

  Page_Person = (function(_super) {
    var films_deck;

    __extends(Page_Person, _super);

    films_deck = void 0;

    function Page_Person(conf) {
      this.conf = conf;
      Page_Person.__super__.constructor.apply(this, arguments);
      films_deck = new FilmsDeck($("#films"), {
        load_func: (function(_this) {
          return function(deck) {
            return _this.load_more_films(deck);
          };
        })(this)
      });
      films_deck.load_more_bind($("#films_more"));
      this._e.subscribe_btn = $("#subscribe_btn").click((function(_this) {
        return function() {
          return _this.action_subscribe();
        };
      })(this));
    }

    Page_Person.prototype.action_subscribe = function(status) {
      return this._app.person_action(this.conf.id, "subscribe", {
        rel: this.conf.relation,
        status: status,
        callback: (function(_this) {
          return function() {
            return alert("done");
          };
        })(this)
      });
    };

    Page_Person.prototype.load_more_films = function(deck) {
      var current_counter;
      current_counter = deck.load_counter;
      deck.load_more_hide();
      return this._app.rest.persons.filmography.read(this.conf.id, {}).done((function(_this) {
        return function(data) {
          if (current_counter !== deck.load_counter) {
            return;
          }
          if (data.items) {
            deck.add_items(data.items);
          }
          if (Math.ceil(data.total_cnt / data.per_page) > data.page) {
            deck.load_more_show();
            return deck.page = data.page;
          }
        };
      })(this)).fail((function(_this) {
        return function(data) {};
      })(this));
    };

    return Page_Person;

  })(Page);

  Page_Playlist = (function(_super) {
    var actors_deck, comments_deck, film, locations;

    __extends(Page_Playlist, _super);

    film = void 0;

    comments_deck = void 0;

    actors_deck = void 0;

    locations = {};

    function Page_Playlist(conf) {
      var item, key, loc_id, self;
      this.conf = conf;
      Page_Playlist.__super__.constructor.apply(this, arguments);
      comments_deck = new CommentsDeck($("#comments"));
      actors_deck = new PersonsDeck($("#actors"), {
        load_func: (function(_this) {
          return function() {
            return _this.load_all_actors();
          };
        })(this)
      });
      actors_deck.load_more_bind($("#actors_more"));
      this._e.rateit = $("#rateit");
      this._e.rateit.rateit("min", 0).rateit("max", 10).bind("beforerated beforereset", (function(_this) {
        return function(event) {
          if (!_this.user_is_auth()) {
            return event.preventDefault();
          }
        };
      })(this)).bind("reset rated", (function(_this) {
        return function(event) {
          return _this.action_rate(_this._e.rateit.rateit("value"));
        };
      })(this));
      this._e.notwatch_btn = $("#notwatch_btn");
      if (this._e.notwatch_btn.length) {
        this._e.notwatch_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_notwatch_toggle();
          };
        })(this));
      }
      this._e.playlist_btn = $("#playlist_btn");
      if (this._e.playlist_btn.length) {
        this._e.playlist_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_playlist_toggle();
          };
        })(this));
      }
      this._e.subscribe_btn = $("#subscribe_btn");
      if (this._e.subscribe_btn.length) {
        this._e.subscribe_btn.bind("click", (function(_this) {
          return function() {
            return _this.action_subscribe_toggle();
          };
        })(this));
      }
      self = this;
      film = this.conf.film;
      if (film.locations && film.locations.length) {
        $(".location-thumb", $("#locations")).each(function() {
          var $this, i, id, loc;
          $this = $(this);
          id = $this.data("miVal");
          i = 0;
          loc = void 0;
          while (i < film.locations.length && film.locations[i].id !== id) {
            i++;
          }
          if (i < film.locations.length) {
            loc = film.locations[i];
          }
          if (loc) {
            $this.click(function() {
              return self.play_location(id);
            });
            $(".type", $this).text(location_type_to_text(loc.type));
            if (loc.price_type === 0 || loc.price === 0) {
              $(".price", $this).text("смотреть бесплатно");
            } else {
              $(".price", $this).text(loc.price + " р.");
            }
            loc._el = $this;
            return locations[id] = loc;
          }
        });
        this.player = new Player($("#player"));
        this.player.clear();
        loc_id = this._app.query_params("loc");
        if (!loc_id) {
          for (key in locations) {
            item = locations[key];
            if (item.price_type === 0) {
              loc_id = key;
            }
          }
        }
        if (loc_id) {
          this.play_location(loc_id);
        }
      }
    }

    Page_Playlist.prototype.play_location = function(id) {
      if (locations[id]) {
        return this.player.load(locations[id]);
      }
    };

    Page_Playlist.prototype.load_all_actors = function() {
      actors_deck.load_more_hide();
      return this._app.rest.films.persons.read(film.id, {
        type: "a",
        top: actors_deck.get_items().length
      }).done((function(_this) {
        return function(data) {
          if (data && data.length) {
            return actors_deck.add_items(data);
          }
        };
      })(this));
    };

    Page_Playlist.prototype.action_rate = function(val) {
      return this._app.film_action(film.id, "rate", {
        rel: this.conf.relation,
        value: val,
        callback: (function(_this) {
          return function(new_value) {
            return alert("done");
          };
        })(this)
      });
    };

    Page_Playlist.prototype.action_notwatch_toggle = function(status) {
      return this._app.film_action(film.id, "notwatch", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    Page_Playlist.prototype.action_subscribe_toggle = function(status) {
      return this._app.film_action(film.id, "subscribe", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    Page_Playlist.prototype.action_playlist_toggle = function(status) {
      return this._app.film_action(film.id, "playlist", {
        state: status,
        rel: this.conf.relation,
        callback: (function(_this) {
          return function() {};
        })(this)
      });
    };

    return Page_Playlist;

  })(Page);

  window.InitApp = function(opts, page_name) {
    if (opts == null) {
      opts = {};
    }
    new App(opts, page_name);
    return delete window.InitApp;
  };

}).call(this);
